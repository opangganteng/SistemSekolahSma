@{
    ViewData["Title"] = "Laporan Presensi";
    var bulan = ViewBag.Bulan ?? DateTime.Now.Month;
    var tahun = ViewBag.Tahun ?? DateTime.Now.Year;
    var laporanSiswa = ViewBag.LaporanSiswa as IEnumerable<dynamic>;
    var laporanGuru = ViewBag.LaporanGuru as IEnumerable<dynamic>;
    var isCetak = ViewBag.IsCetak ?? false;

    string[] namaBulan = {"", "Januari", "Februari", "Maret", "April", "Mei", "Juni",
                          "Juli", "Agustus", "September", "Oktober", "November", "Desember"};

    // Helper function untuk handle null values
    int GetSafeInt(dynamic value)
    {
        if (value == null) return 0;
        if (int.TryParse(value.ToString(), out int result))
            return result;
        return 0;
    }
}

@if (isCetak)
{
    <!-- ========================= PRINT VERSION ========================= -->
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Laporan Presensi @namaBulan[bulan] @tahun</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                font-size: 11px;
                line-height: 1.4;
            }

            .header {
                text-align: center;
                margin-bottom: 30px;
            }

                .header h1 {
                    margin: 0;
                    font-size: 18px;
                    font-weight: bold;
                }

                .header h2 {
                    margin: 5px 0;
                    font-size: 14px;
                    color: #666;
                }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            th, td {
                border: 1px solid #333;
                padding: 4px 2px;
                text-align: center;
                font-size: 9px;
            }

            th {
                background-color: #f0f0f0;
                font-weight: bold;
            }

            .text-left {
                text-align: left !important;
            }

            .empty-state {
                text-align: center;
                color: #666;
                margin-top: 50px;
                font-size: 12px;
            }

            .media print {
                body

            {
                margin: 0;
                font-size: 10px;
            }

            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>Laporan Presensi Siswa</h1>
            <h2>Bulan: @namaBulan[bulan] @tahun</h2>
        </div>

        @if (laporanSiswa != null && laporanSiswa.Any())
        {
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>NISN</th>
                        <th>Nama Siswa</th>
                        <th>Kelas</th>
                        <th>Hadir</th>
                        <th>Izin</th>
                        <th>Sakit</th>
                        <th>Alpha</th>
                        <th>Total</th>
                        <th>Persentase</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        int no = 1;
                    }
                    @foreach (var siswa in laporanSiswa)
                    {
                        int hadir = GetSafeInt(siswa.TotalHadir) + GetSafeInt(siswa.Hadir);
                        int izin = GetSafeInt(siswa.TotalIzin) + GetSafeInt(siswa.Izin);
                        int sakit = GetSafeInt(siswa.TotalSakit) + GetSafeInt(siswa.Sakit);
                        int alpha = GetSafeInt(siswa.TotalAlpha) + GetSafeInt(siswa.Alpha);
                        int totalHari = hadir + izin + sakit + alpha;
                        double persentase = totalHari > 0 ? (double)hadir / totalHari * 100 : 0;

                        <tr>
                            <td>@no</td>
                            <td>@(siswa.NISN ?? "N/A")</td>
                            <td class="text-left">@(siswa.NamaSiswa ?? "N/A")</td>
                            <td>@(siswa.NamaKelas ?? "N/A")</td>
                            <td>@hadir</td>
                            <td>@izin</td>
                            <td>@sakit</td>
                            <td>@alpha</td>
                            <td>@totalHari</td>
                            <td>@persentase.ToString("F1")%</td>
                        </tr>
                        no++;
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="empty-state">
                <p>Tidak ada data presensi siswa untuk bulan @namaBulan[bulan] @tahun</p>
            </div>
        }

        <script>
            window.onload = function() {
                window.print();
                window.onafterprint = function() {
                    window.close();
                };
            };
        </script>
    </body>
    </html>
}
else
{
    <!-- ========================= NORMAL VIEW ========================= -->
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Laporan Presensi - @namaBulan[bulan] @tahun
                        </h4>
                    </div>
                    <div class="card-body">

                        <!-- Alert Messages -->
                        @if (TempData["Error"] != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                @TempData["Error"]
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }

                        @if (TempData["Success"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fas fa-check-circle me-2"></i>
                                @TempData["Success"]
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        }

                        <!-- Filter Section -->
                        <div class="row mb-4">
                            <div class="col-lg-8 col-md-10">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-transparent border-0">
                                        <h6 class="mb-0 text-primary">
                                            <i class="fas fa-filter me-2"></i>Filter Laporan
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <form asp-action="FilterLaporan" method="post" class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold">
                                                    <i class="fas fa-calendar-alt me-1"></i>Bulan
                                                </label>
                                                <select name="bulan" class="form-select">
                                                    @for (int i = 1; i <= 12; i++)
                                                    {
                                                        <option value="@i" selected="@(i == bulan ? "selected" : null)">
                                                            @namaBulan[i]
                                                        </option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label fw-bold">
                                                    <i class="fas fa-calendar me-1"></i>Tahun
                                                </label>
                                                <select name="tahun" class="form-select">
                                                    @for (int i = DateTime.Now.Year - 2; i <= DateTime.Now.Year + 1; i++)
                                                    {
                                                        <option value="@i" selected="@(i == tahun ? "selected" : null)">
                                                            @i
                                                        </option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="submit" class="btn btn-primary d-grid w-100">
                                                    <i class="fas fa-search me-2"></i>Filter Data
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Export Buttons -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-success" onclick="exportToExcel()">
                                        <i class="fas fa-file-excel me-2"></i>Export ke Excel
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="exportToPDF()">
                                        <i class="fas fa-file-pdf me-2"></i>Export ke PDF
                                    </button>
                                    <button type="button" class="btn btn-info" onclick="cetakLaporan()">
                                        <i class="fas fa-print me-2"></i>Cetak Laporan
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs" id="laporanTab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="siswa-tab" data-bs-toggle="tab" data-bs-target="#siswa" type="button" role="tab">
                                    <i class="fas fa-users me-2"></i>Laporan Presensi Siswa
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="guru-tab" data-bs-toggle="tab" data-bs-target="#guru" type="button" role="tab">
                                    <i class="fas fa-chalkboard-teacher me-2"></i>Laporan Presensi Guru
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content mt-3" id="laporanTabContent">
                            <!-- =============== TAB SISWA =============== -->
                            <div class="tab-pane fade show active" id="siswa" role="tabpanel">

                                @if (laporanSiswa != null && laporanSiswa.Any())
                                {
                                    <!-- Search Input -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" class="form-control" id="searchSiswa" placeholder="Cari berdasarkan nama atau NISN...">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table Siswa -->
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabelSiswa">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th class="text-center">No</th>
                                                    <th>NISN</th>
                                                    <th>Nama Siswa</th>
                                                    <th class="text-center">Kelas</th>
                                                    <th class="text-center">Hadir</th>
                                                    <th class="text-center">Izin</th>
                                                    <th class="text-center">Sakit</th>
                                                    <th class="text-center">Alpha</th>
                                                    <th class="text-center">Total</th>
                                                    <th class="text-center">Persentase</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int no = 1;
                                                }
                                                @foreach (var siswa in laporanSiswa)
                                                {
                                                    int hadir = GetSafeInt(siswa.TotalHadir) + GetSafeInt(siswa.Hadir);
                                                    int izin = GetSafeInt(siswa.TotalIzin) + GetSafeInt(siswa.Izin);
                                                    int sakit = GetSafeInt(siswa.TotalSakit) + GetSafeInt(siswa.Sakit);
                                                    int alpha = GetSafeInt(siswa.TotalAlpha) + GetSafeInt(siswa.Alpha);
                                                    int totalHari = hadir + izin + sakit + alpha;
                                                    double persentase = totalHari > 0 ? (double)hadir / totalHari * 100 : 0;
                                                    string progressBarClass = persentase >= 80 ? "bg-success" : persentase >= 60 ? "bg-warning" : "bg-danger";

                                                    <tr>
                                                        <td class="text-center fw-bold">@no</td>
                                                        <td>@(siswa.NISN ?? "N/A")</td>
                                                        <td>@(siswa.NamaSiswa ?? "N/A")</td>
                                                        <td class="text-center">
                                                            <span class="badge bg-secondary">@(siswa.NamaKelas ?? "N/A")</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-success">@hadir</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-warning">@izin</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-info">@sakit</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-danger">@alpha</span>
                                                        </td>
                                                        <td class="text-center fw-bold">@totalHari</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar @progressBarClass"
                                                                     style="width: @(persentase)%"
                                                                     role="progressbar">
                                                                    <small class="fw-bold text-white">@persentase.ToString("F1")%</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    no++;
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <!-- Empty State Siswa -->
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <i class="fas fa-inbox text-muted" style="font-size: 4rem;"></i>
                                        </div>
                                        <h5 class="text-muted mb-2">Belum Ada Data Presensi Siswa</h5>
                                        <p class="text-muted">
                                            Data presensi siswa untuk bulan @namaBulan[bulan] @tahun belum tersedia.
                                        </p>
                                    </div>
                                }
                            </div>

                            <!-- =============== TAB GURU =============== -->
                            <div class="tab-pane fade" id="guru" role="tabpanel">

                                @if (laporanGuru != null && laporanGuru.Any())
                                {
                                    <!-- Search Input -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-search"></i>
                                                </span>
                                                <input type="text" class="form-control" id="searchGuru" placeholder="Cari berdasarkan nama atau NIP...">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Table Guru -->
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover" id="tabelGuru">
                                            <thead class="table-success">
                                                <tr>
                                                    <th class="text-center">No</th>
                                                    <th>NIP</th>
                                                    <th>Nama Guru</th>
                                                    <th class="text-center">Hadir</th>
                                                    <th class="text-center">Izin</th>
                                                    <th class="text-center">Sakit</th>
                                                    <th class="text-center">Alpha</th>
                                                    <th class="text-center">Total</th>
                                                    <th class="text-center">Persentase</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @{
                                                    int noGuru = 1;
                                                }
                                                @foreach (var guru in laporanGuru)
                                                {
                                                    int hadir = GetSafeInt(guru.TotalHadir) + GetSafeInt(guru.Hadir);
                                                    int izin = GetSafeInt(guru.TotalIzin) + GetSafeInt(guru.Izin);
                                                    int sakit = GetSafeInt(guru.TotalSakit) + GetSafeInt(guru.Sakit);
                                                    int alpha = GetSafeInt(guru.TotalAlpha) + GetSafeInt(guru.Alpha);
                                                    int totalMengajar = hadir + izin + sakit + alpha;
                                                    double persentase = totalMengajar > 0 ? (double)hadir / totalMengajar * 100 : 0;
                                                    string progressBarClass = persentase >= 90 ? "bg-success" : persentase >= 75 ? "bg-warning" : "bg-danger";

                                                    <tr>
                                                        <td class="text-center fw-bold">@noGuru</td>
                                                        <td>@(guru.NIP ?? "N/A")</td>
                                                        <td>@(guru.NamaGuru ?? "N/A")</td>
                                                        <td class="text-center">
                                                            <span class="badge bg-success">@hadir</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-warning">@izin</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-info">@sakit</span>
                                                        </td>
                                                        <td class="text-center">
                                                            <span class="badge bg-danger">@alpha</span>
                                                        </td>
                                                        <td class="text-center fw-bold">@totalMengajar</td>
                                                        <td>
                                                            <div class="progress" style="height: 20px;">
                                                                <div class="progress-bar @progressBarClass"
                                                                     style="width: @(persentase)%"
                                                                     role="progressbar">
                                                                    <small class="fw-bold text-white">@persentase.ToString("F1")%</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    noGuru++;
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                }
                                else
                                {
                                    <!-- Empty State Guru -->
                                    <div class="text-center py-5">
                                        <div class="mb-4">
                                            <i class="fas fa-chalkboard-teacher text-muted" style="font-size: 4rem;"></i>
                                        </div>
                                        <h5 class="text-muted mb-2">Belum Ada Data Presensi Guru</h5>
                                        <p class="text-muted">
                                            Data presensi guru untuk bulan @namaBulan[bulan] @tahun belum tersedia.
                                        </p>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Summary Statistics -->
                        @if (laporanSiswa != null && laporanSiswa.Any())
                        {
                            var totalSiswa = laporanSiswa.Count();
                            var siswaHadirBaik = laporanSiswa.Where(s =>
                            {
                                int hadir = GetSafeInt(s.TotalHadir) + GetSafeInt(s.Hadir);
                                int total = hadir + GetSafeInt(s.TotalIzin) + GetSafeInt(s.Izin) + GetSafeInt(s.TotalSakit) + GetSafeInt(s.Sakit) + GetSafeInt(s.TotalAlpha) + GetSafeInt(s.Alpha);
                                return total > 0 && ((double)hadir / total * 100) >= 80;
                            }).Count();

                            <div class="row mt-5">
                                <div class="col-md-12">
                                    <div class="card border-0 bg-light">
                                        <div class="card-header bg-transparent border-0">
                                            <h6 class="mb-0 text-primary">
                                                <i class="fas fa-chart-pie me-2"></i>Ringkasan Statistik
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row text-center">
                                                <div class="col-md-3 col-6">
                                                    <div class="p-3">
                                                        <h4 class="text-primary">@totalSiswa</h4>
                                                        <small class="text-muted">Total Siswa</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-6">
                                                    <div class="p-3">
                                                        <h4 class="text-success">@siswaHadirBaik</h4>
                                                        <small class="text-muted">Kehadiran ≥ 80%</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-6">
                                                    <div class="p-3">
                                                        <h4 class="text-warning">@(totalSiswa - siswaHadirBaik)</h4>
                                                        <small class="text-muted">Kehadiran &lt; 80%</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-6">
                                                    <div class="p-3">
                                                        <h4 class="text-info">@((double)siswaHadirBaik / totalSiswa * 100).ToString("F1")%</h4>
                                                        <small class="text-muted">Persentase Baik</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            function exportToExcel() {
                const bulan = @bulan;
                const tahun = @tahun;

                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exporting...';
                btn.disabled = true;

                window.open('/Admin/ExportExcel?bulan=' + bulan + '&tahun=' + tahun, '_blank');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            }

            function exportToPDF() {
                const bulan = @bulan;
                const tahun = @tahun;

                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
                btn.disabled = true;

                window.open('/Admin/ExportPDF?bulan=' + bulan + '&tahun=' + tahun, '_blank');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 2000);
            }

            function cetakLaporan() {
                const bulan = @bulan;
                const tahun = @tahun;

                const btn = event.target;
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Preparing...';
                btn.disabled = true;

                window.open('/Admin/CetakLaporan?bulan=' + bulan + '&tahun=' + tahun, '_blank');

                setTimeout(function() {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 1500);
            }

            function initializeSearch() {
                const searchSiswa = document.getElementById('searchSiswa');
                const tabelSiswa = document.getElementById('tabelSiswa');

                if (searchSiswa && tabelSiswa) {
                    searchSiswa.addEventListener('keyup', function() {
                        const filter = this.value.toLowerCase();
                        const rows = tabelSiswa.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

                        for (let i = 0; i < rows.length; i++) {
                            const cells = rows[i].getElementsByTagName('td');
                            let found = false;

                            if (cells.length > 2) {
                                const nisn = cells[1].textContent.toLowerCase();
                                const nama = cells[2].textContent.toLowerCase();

                                if (nisn.includes(filter) || nama.includes(filter)) {
                                    found = true;
                                }
                            }

                            rows[i].style.display = found ? '' : 'none';
                        }
                    });
                }

                const searchGuru = document.getElementById('searchGuru');
                const tabelGuru = document.getElementById('tabelGuru');

                if (searchGuru && tabelGuru) {
                    searchGuru.addEventListener('keyup', function() {
                        const filter = this.value.toLowerCase();
                        const rows = tabelGuru.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

                        for (let i = 0; i < rows.length; i++) {
                            const cells = rows[i].getElementsByTagName('td');
                            let found = false;

                            if (cells.length > 2) {
                                const nip = cells[1].textContent.toLowerCase();
                                const nama = cells[2].textContent.toLowerCase();

                                if (nip.includes(filter) || nama.includes(filter)) {
                                    found = true;
                                }
                            }

                            rows[i].style.display = found ? '' : 'none';
                        }
                    });
                }
            }

            document.addEventListener('DOMContentLoaded', function() {
                initializeSearch();

                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    setTimeout(function() {
                        if (typeof bootstrap !== 'undefined' && bootstrap.Alert) {
                            const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                            bsAlert.close();
                        }
                    }, 5000);
                });
            });
        </script>
    }
}